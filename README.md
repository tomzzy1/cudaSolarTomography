# graduate_thesis_project

## Prerequisites

CMake (Version >= 3.20) , older version (>= 2.80) may also work

C++ Compiler with C++17 support, for gcc, version >= 8.5.0 should work

CUDA toolkit (>= 11.0) (CuBLAS, CuSparse) and CUDA runtime

## How to work with the project
1. change the current directory to the root directory
2. create folders in the directory for storing config files and data files. Then set the "config_dir" and "fits_dir" to the corresponding paths in "build_params.hpp". The config file can be generated by “python/make_config.py” and the data files in a folder.
3. run the following commands: <br />
   * 3.1. build LibWCS <br />
      cd libwcs <br />
      make <br />
      cd .. <br />
   * 3.2. build solver <br />
      cd solver <br />
      mkdir build <br />
      cd build <br />
      cmake .. <br />
      make <br />
      cd ../.. <br />
   * 3.3 build the project <br />
      mkdir build <br />
      cd build <br />
      cmake -DCUDA_TOOLKIT_VERSION:=12 .. <br />
      make <br />
set the CUDA_TOOLKIT_VERSION to your cuda toolkit version, only 11 and 12 are supported. Use 11 on HAL.
4. Set other build parameters in "build_params.hpp"

### Experiements
The experiments is conducted with the new Python interface. <br />
Setup on PC: install all necessary packages (numpy, scipy, h5py) and run pip install . in root directory. <br />
Setup on HAL: 
1. Load Conda module: run "module load conda_base" on HAL
2. Create your Conda environment: conda create --name my-env;  Replace my-env with the name of your environment.
3. Activate your Conda environment: conda activate my-nev
4. install pybind11: conda install conda-forge::pybind11. If you need to install more packages such as numpy, scipy, h5py, also use conda install
5. run the script ./hal_build_pybind.sh (The "fits_dir" in "build_params.hpp" should match the path you use in the sciprt "experiement.py", or the "fits_dir" should contain all files that you passed in the function in the scirpt, so that the underlying C++ code can find the files)

Experiemnts: run the script with cd python & ./experiment.py prog, for other details, please check comments in the script <br />
Prog 0: Generate interpolated MHD volumes from original MHD volumes <br />
Prog 1: Interpolate from the interpolated MHD volumes as the ground truth (alternated interpolation method in thesis) <br />
Prog 2: Synthesize images of different resolution <br />
Prog 3: Experiments of resolutions. Reconstruct with different resolutions from the synthesize images of varing resolution <br />
Prog 4: Generate synthetic images with virtual viewpoints (the view angle is determined by the first and last real viewpoints) <br />
Prog 5: Reconstruct with synthetic images generated by Prog 4 <br />
Prog 6: Generate synthetic images with virtual viewpoints (the view angle can be arbitrary) <br />
Prog 7: Reconstruct with synthetic images generated by Prog 6 <br />

## Possible Problems and Solutions
1. The solver in default use float as data types, if you need to change to double, set "real" to double in "type.hpp". Then rebuild the solver and the project. For python interfrace, rebuild the solver and run ./hal_build_pybind.sh.
2. If you meet the problem of exceeding the shared memory of GPU, set the "binning_global" in “build_A_matrix.cuh” to true (Or adjust the threshold of shared memory use, the current 0xc000 is the limit on V100)
